import numpy as np
import joblib
import json
import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import shutil
from datetime import datetime
import sys

# Sklearn Imports
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.svm import SVC
from sklearn.neighbors import KNeighborsClassifier
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix

# Boosting Libraries (Eğer yüklü değilse: pip install xgboost catboost)
try:
    from xgboost import XGBClassifier
    from catboost import CatBoostClassifier
except ImportError:
    print("XGBoost veya CatBoost yüklü değil. Lütfen 'pip install xgboost catboost' komutunu çalıştırın.")
    sys.exit()

# --- Configuration ---
DATA_DIRECTORY = "deletedrows"  # Gesture alt klasörlerini içeren ana klasör
WINDOW_SIZE = 100
WINDOW_STEP = 50

class GestureClassifier:
    def __init__(self):
        self.scaler = None
        self.gesture_map = {}
        
    def organize_files(self, base_path):
        """
        Dosyaları ismine göre (örn: 'yumruk_1.npy') ilgili klasörlere taşır.
        """
        print(f"Klasörler düzenleniyor: {base_path}...")
        if not os.path.exists(base_path):
            print(f"Uyarı: {base_path} bulunamadı.")
            return

        participants = [d for d in os.listdir(base_path) if os.path.isdir(os.path.join(base_path, d))]
        
        for p_name in participants:
            p_folder = os.path.join(base_path, p_name)
            files = [f for f in os.listdir(p_folder) if f.lower().endswith('.npy') and os.path.isfile(os.path.join(p_folder, f))]
            
            if not files: continue
                
            for fname in files:
                gesture_name = fname.split('_')[0]
                gesture_folder = os.path.join(p_folder, gesture_name)
                os.makedirs(gesture_folder, exist_ok=True)
                
                src_path = os.path.join(p_folder, fname)
                dst_path = os.path.join(gesture_folder, fname)
                
                try:
                    shutil.move(src_path, dst_path)
                except Exception as e:
                    print(f"Hata: {fname} taşınamadı. {e}")
        print("Düzenleme tamamlandı.")

    @staticmethod
    def extract_features(data, window_size=WINDOW_SIZE, window_step=WINDOW_STEP):
        """
        Zaman alanı öznitelik çıkarımı (MAV, WL, ZC, SSC).
        """
        n_samples, n_channels = data.shape
        features = []

        for start in range(0, n_samples - window_size + 1, window_step):
            end = start + window_size
            window = data[start:end, :]

            window_features = []
            for i in range(n_channels):
                channel_data = window[:, i]
                # 1. Mean Absolute Value (MAV)
                mav = np.mean(np.abs(channel_data))
                # 2. Waveform Length (WL)
                wl = np.sum(np.abs(np.diff(channel_data)))
                # 3. Zero Crossings (ZC)
                zc = np.sum(np.diff(np.sign(channel_data)) != 0)
                # 4. Slope Sign Changes (SSC)
                ssc = np.sum(np.diff(np.sign(np.diff(channel_data))) != 0)

                window_features.extend([mav, wl, zc, ssc])
            features.append(window_features)
        return np.array(features)

    def _load_nested_data(self, base_path):
        """
        Veri setini yükler ve etiketler.
        """
        all_features, all_labels = [], []
        print(f"Veri taranıyor: {base_path}")
        
        for root, dirs, files in os.walk(base_path):
            npy_files = [f for f in files if f.lower().endswith('.npy')]
            if not npy_files: continue

            gesture_name = os.path.basename(root)
            if gesture_name not in self.gesture_map:
                self.gesture_map[gesture_name] = len(self.gesture_map)
            
            label = self.gesture_map[gesture_name]
            
            for file_name in npy_files:
                data = np.load(os.path.join(root, file_name))
                if data.size > 0:
                    feats = self.extract_features(data)
                    if feats.shape[0] > 0:
                        all_features.append(feats)
                        all_labels.append(np.full(feats.shape[0], label))

        if not all_features:
            print("Hata: Veri bulunamadı!")
            return None, None, None

        X = np.vstack(all_features)
        y = np.concatenate(all_labels)
        return X, y, self.gesture_map

    def train_single_model(self, model_name, model_obj, params, X_train, y_train, X_test, y_test, date_str):
        """
        Tek bir model için GridSearch yapar, raporlar ve kaydeder.
        """
        print(f"\n{'='*20} {model_name} Modeli Eğitiliyor {'='*20}")
        
        # Grid Search Başlat
        grid = GridSearchCV(estimator=model_obj, param_grid=params, 
                            cv=3, n_jobs=-1, scoring='accuracy', verbose=1)
        grid.fit(X_train, y_train)
        
        best_model = grid.best_estimator_
        y_pred = best_model.predict(X_test)
        acc = accuracy_score(y_test, y_pred)
        
        # Dosya İsimleri
        report_filename = f"report_{model_name}_{date_str}.txt"
        best_filename = f"best_{model_name}_{date_str}"

        # 1. Raporu Kaydet (Tüm kombinasyonlar)
        with open(report_filename, "w", encoding="utf-8") as f:
            f.write(f"{model_name} HYPERPARAMETER REPORT - {date_str}\n")
            f.write("="*100 + "\n")
            f.write(f"{'Rank':<5} | {'Mean Acc':<10} | {'Parameters'}\n")
            f.write("-" * 100 + "\n")
            
            results = grid.cv_results_
            for i in range(len(results['params'])):
                rank = results['rank_test_score'][i]
                mean_acc = results['mean_test_score'][i]
                p_str = str(results['params'][i])
                f.write(f"{rank:<5} | {mean_acc*100:>8.2f}% | {p_str}\n")
            
            f.write("\n" + "="*100 + "\n")
            f.write(f"EN IYI MODEL: {grid.best_params_}\n")
            f.write(f"Test Seti Accuracy: {acc*100:.2f}%\n")

        # 2. En İyi Model Metriklerini Kaydet
        report_str = classification_report(y_test, y_pred, target_names=list(self.gesture_map.keys()))
        cm = confusion_matrix(y_test, y_pred)
        
        with open(f"{best_filename}_metrics.txt", "w", encoding="utf-8") as f:
            f.write(f"BEST {model_name} EVALUATION\n")
            f.write(f"Best Params: {grid.best_params_}\n\n")
            f.write(f"Accuracy: {acc:.4f}\n\n")
            f.write("Classification Report:\n")
            f.write(report_str)
            f.write("\nConfusion Matrix:\n")
            f.write(np.array2string(cm))

        # 3. Confusion Matrix Çiz ve Kaydet
        plt.figure(figsize=(10, 8))
        sns.heatmap(cm, annot=True, fmt='d', cmap='Blues',
                    xticklabels=self.gesture_map.keys(), yticklabels=self.gesture_map.keys())
        plt.title(f'{model_name} Confusion Matrix\nAcc: {acc:.2f}')
        plt.ylabel('True Label')
        plt.xlabel('Predicted Label')
        plt.savefig(f"{best_filename}_cm.png")
        plt.close() # Bellek şişmesini önlemek için kapat
        
        print(f"Tamamlandı: {model_name} | Acc: {acc:.4f} | Rapor: {report_filename}")
        return acc

    def run_multi_model_training(self):
        # 1. Veri Hazırlığı
        self.organize_files(DATA_DIRECTORY)
        X, y, gesture_map = self._load_nested_data(DATA_DIRECTORY)
        if X is None: return

        print(f"Toplam Veri Boyutu: {X.shape}, Sınıflar: {gesture_map}")

        # Split ve Scale
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.25, random_state=42, stratify=y
        )
        self.scaler = StandardScaler()
        X_train = self.scaler.fit_transform(X_train)
        X_test = self.scaler.transform(X_test)
        
        date_str = datetime.now().strftime("%d%m%Y_%H%M")
        
        # --- MODEL KONFİGÜRASYONLARI ---
        models_config = [
            {
                "name": "SVM",
                "model": SVC(random_state=42),
                "params": {
                    'C': [0.1, 1, 10, 100],
                    'kernel': ['linear', 'rbf', 'poly'],
                    'gamma': ['scale', 'auto']
                }
            },
            {
                "name": "XGBoost",
                "model": XGBClassifier(use_label_encoder=False, eval_metric='mlogloss', random_state=42),
                "params": {
                    'n_estimators': [50, 100, 150, 200],
                    'max_depth': [3, 5, 7],
                    'learning_rate': [0.01, 0.1, 0.2]
                }
            },
            {
                "name": "CatBoost",
                "model": CatBoostClassifier(verbose=0, random_state=42),
                "params": {
                    'iterations': [50, 100, 150, 200],
                    'depth': [4, 6, 8],
                    'learning_rate': [0.01, 0.1]
                }
            },
            {
                "name": "K-NN",
                "model": KNeighborsClassifier(),
                "params": {
                    'n_neighbors': [3, 5, 7, 9, 11],
                    'weights': ['uniform', 'distance'],
                    'metric': ['euclidean', 'manhattan']
                }
            }
        ]

        # Sonuçları karşılaştırmak için liste
        final_results = []

        # --- DÖNGÜ: Tüm modelleri sırayla eğit ---
        for config in models_config:
            acc = self.train_single_model(
                model_name=config["name"],
                model_obj=config["model"],
                params=config["params"],
                X_train=X_train, y_train=y_train,
                X_test=X_test, y_test=y_test,
                date_str=date_str
            )
            final_results.append({"Model": config["name"], "Accuracy": acc})

        # --- FİNAL KARŞILAŞTIRMA GRAFİĞİ ---
        print("\n=== TÜM MODELLER TAMAMLANDI ===")
        results_df = pd.DataFrame(final_results)
        print(results_df)

        plt.figure(figsize=(10, 6))
        sns.barplot(x="Model", y="Accuracy", data=results_df, palette="viridis")
        plt.title(f"Model Karşılaştırması - {date_str}")
        plt.ylim(0, 1.05)
        for index, row in results_df.iterrows():
            plt.text(index, row.Accuracy + 0.01, f"%{row.Accuracy*100:.1f}", color='black', ha="center")
        
        plt.savefig(f"Final_Model_Comparison_{date_str}.png")
        print(f"Karşılaştırma grafiği kaydedildi: Final_Model_Comparison_{date_str}.png")

if __name__ == "__main__":
    clf = GestureClassifier()
    clf.run_multi_model_training()